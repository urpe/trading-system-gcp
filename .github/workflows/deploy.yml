name: deploy
on:
  push:
    branches: [ main ]
env:
  PROJECT_ID: mi-proyecto-trading-12345
  REGION: us-central1

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - id: auth
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Deploy Services
      run: |
        # 1. Market Data Hub (EUROPA) - Puerto 8080
        gcloud run deploy market-data-hub --source ./services/market_data_hub --region europe-west1 --quiet --allow-unauthenticated
        
        # 2. Dashboard (USA) - Usando Gunicorn
        gcloud run deploy dashboard --source ./dashboard --region us-central1 --quiet --allow-unauthenticated --set-env-vars "PORT=8080"
        
        # 3. Strategy Agent (USA) - Ahora como Servidor
        gcloud run deploy strategy-agent --source ./strategy_agent --region us-central1 --quiet --allow-unauthenticated
        
        # 4. Motores de Backend (USA)
        gcloud run deploy pairs-trading-engine --source ./services/pairs-trading --region us-central1 --quiet --allow-unauthenticated
        gcloud run deploy backtesting-simulator --source ./services/backtesting-simulator --region us-central1 --quiet --allow-unauthenticated
