services:
  # --- CORE UI ---
  dashboard:
    build: .
    command: python src/services/dashboard/app.py
    ports: ["8050:8050"]
    environment:
      - PROJECT_ID=mi-proyecto-trading-12345
      - PYTHONUNBUFFERED=1
    volumes:
      - ./src:/app/src
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # --- CORE TRADING ---
  # portfolio:  # DISABLED V17: Orders service handles wallet/portfolio management
  #   build: .
  #   command: python src/services/portfolio/main.py
  #   environment:
  #     - PROJECT_ID=mi-proyecto-trading-12345
  #     - PYTHONUNBUFFERED=1
  #   volumes:
  #     - ./src:/app/src

  orders:
    build: .
    command: python src/services/orders/main.py
    environment:
      - PROJECT_ID=mi-proyecto-trading-12345
      - PYTHONUNBUFFERED=1
    volumes:
      - ./src:/app/src
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  brain:
    build: .
    command: python src/services/brain/main.py
    environment:
      - PROJECT_ID=mi-proyecto-trading-12345
      - PYTHONUNBUFFERED=1
    volumes:
      - ./src:/app/src
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # --- V18: STRATEGY OPTIMIZER (Background Worker) ---
  strategy-optimizer:
    build: .
    command: python src/services/strategy_optimizer/main.py
    environment:
      - PROJECT_ID=mi-proyecto-trading-12345
      - PYTHONUNBUFFERED=1
    volumes:
      - ./src:/app/src
    depends_on:
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # --- ADVANCED MODULES (RESTORED) ---
  # pairs:  # V19.1: DISABLED - Reduce ruido del sistema, enfoque en Mean Reversion
  #   build: .
  #   command: python src/services/pairs/main.py
  #   environment:
  #     - PROJECT_ID=mi-proyecto-trading-12345
  #     - PYTHONUNBUFFERED=1
  #   volumes:
  #     - ./src:/app/src

  simulator:
    build: .
    command: python src/services/simulator/main.py
    environment:
      - PROJECT_ID=mi-proyecto-trading-12345
      - PYTHONUNBUFFERED=1
    volumes:
      - ./src:/app/src
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # --- DATA SERVICES ---
  redis:
    image: redis:7-alpine
    restart: always
    # V19 Security: Redis only accessible internally (no external port exposure)
    # ports:
    #   - "6379:6379"  # Commented out for security
    volumes:
      - ~/redis_data:/data
    # FinOps V21.1: Optimizar AOF para reducir IOPS
    # appendfsync no -> Sin sincronización (más rápido, menos seguro)
    # appendfsync everysec -> Sync cada segundo (balance)
    # appendfsync always -> Sync cada comando (lento, muy seguro)
    command: redis-server --appendonly yes --appendfsync no --save ""
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  market-data:
    build: .
    command: python src/services/market_data/main.py
    environment:
      - PROJECT_ID=mi-proyecto-trading-12345
      - REDIS_HOST=redis
    volumes:
      - ./src:/app/src
    depends_on:
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  persistence:
    build: .
    command: python src/services/persistence/main.py
    environment:
      - PROJECT_ID=mi-proyecto-trading-12345
      - REDIS_HOST=redis
      - PYTHONUNBUFFERED=1
    volumes:
      - ./src:/app/src
    depends_on:
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  
  historical:
    build: .
    command: python src/services/historical/main.py
    volumes:
      - ./src:/app/src
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  alerts:
    build: .
    command: python src/services/alerts/main.py
    volumes:
      - ./src:/app/src
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"


