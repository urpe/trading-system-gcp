# V21.3 "CANONICAL CORE" - MIGRATION PLAN

## üéØ OBJETIVO ESTRAT√âGICO

**Migrar de strings sueltos a Value Objects (TradingSymbol) de forma sistem√°tica y progresiva, sin romper el sistema.**

---

## üìê FILOSOF√çA DE LA MIGRACI√ìN

```
"Make illegal states unrepresentable"
- Scott Wlaschin (Domain Modeling Made Functional)
```

**NO es un parche. Es arquitectura.**

- **Value Object Pattern** (DDD): TradingSymbol encapsula validaci√≥n + formato
- **Type Safety**: Imposible pasar s√≠mbolos inv√°lidos
- **Inmutabilidad**: frozen dataclass (thread-safe, cacheable)
- **Single Responsibility**: TradingSymbol maneja TODAS las representaciones

---

## ‚úÖ FASE 0: FOUNDATION (COMPLETADA)

- [x] `src/domain/trading_symbol.py` creado
- [x] `src/domain/__init__.py` creado
- [x] `test_trading_symbol.py` ejecutado (9/9 tests PASSED)
- [x] Value Object verificado (inmutabilidad, type safety, formatos)

**Resultado:** Core domain listo para uso.

---

## üîÑ FASE 1: BACKWARD COMPATIBILITY LAYER

### Estrategia
**Migrar `src/shared/utils.py` para usar TradingSymbol internamente**

### Antes (V21.2.1)
```python
def normalize_symbol(symbol: str, format: str = 'short') -> str:
    if symbol is None:
        raise TypeError("Symbol cannot be None")
    # ... validaci√≥n manual ...
    clean = symbol.strip().upper()
    base = clean.replace('USDT', '')
    # ... l√≥gica de formato ...
```

### Despu√©s (V21.3)
```python
from src.domain import TradingSymbol

def normalize_symbol(symbol: str, format: str = 'short') -> str:
    """
    V21.3: Wrapper sobre TradingSymbol Value Object.
    DEPRECATED: Use TradingSymbol directly in new code.
    """
    ts = TradingSymbol.from_str(symbol)
    
    if format == 'short':
        return ts.to_short()
    elif format == 'long':
        return ts.to_long()
    elif format == 'lower':
        return ts.to_lower()
    else:
        raise ValueError(f"Invalid format: {format}")
```

**Ventaja:** Servicios existentes siguen funcionando SIN CAMBIOS.

### Archivos a Modificar
1. `src/shared/utils.py`

### Tests de Verificaci√≥n
```bash
python3 verify_integrity_v21.2.1.py  # Debe seguir pasando 5/5
```

---

## üîÑ FASE 2: DASHBOARD MIGRATION (High Priority)

### Servicios a Migrar
- `src/services/dashboard/app.py`

### Puntos de Cambio

#### 2.1: `get_realtime_price()`
**Antes:**
```python
def get_realtime_price(symbol: str) -> float:
    symbol_normalized = normalize_symbol(symbol, format='short')
    key = f"price:{symbol_normalized}"
    data = memory.get(key)
    # ...
```

**Despu√©s:**
```python
from src.domain import TradingSymbol

def get_realtime_price(symbol_str: str) -> float:
    symbol = TradingSymbol.from_str(symbol_str)
    key = symbol.to_redis_key("price")  # ‚úÖ Type-safe
    data = memory.get(key)
    # ...
```

#### 2.2: `get_market_regimes()`
**Similar pattern:** Convertir `symbol` string ‚Üí `TradingSymbol` ‚Üí usar `.to_redis_key()`

#### 2.3: `dashboard_data()` y `asset_detail()`
**Pattern:** Parsear `active_symbols` con `parse_symbol_list()`

### Tests de Verificaci√≥n
```bash
curl http://localhost:8050/api/dashboard_data
curl http://localhost:8050/asset/BTC
# Ambos deben retornar Status 200, sin errores
```

---

## üîÑ FASE 3: BRAIN SERVICE MIGRATION (Core Logic)

### Servicios a Migrar
- `src/services/brain/main.py`

### Puntos de Cambio

#### 3.1: `warm_up_history()`
**Antes:**
```python
active_symbols = ['BTC', 'ETH', 'SOL']  # strings
for symbol in active_symbols:
    symbol_normalized = normalize_symbol(symbol)
    # ...
```

**Despu√©s:**
```python
from src.domain import TradingSymbol, parse_symbol_list

active_symbols_str = ['BTC', 'ETH', 'SOL']
active_symbols = parse_symbol_list(active_symbols_str)  # List[TradingSymbol]

for symbol in active_symbols:
    # symbol is TradingSymbol, not str
    # symbol.to_binance_api() para API calls
    # symbol.to_short() para logs
```

#### 3.2: `process_market_update()`
**Parsear `data['symbol']` a TradingSymbol al inicio de la funci√≥n**

### Tests de Verificaci√≥n
```bash
docker compose logs brain | grep "WARM-UP COMPLETADO"
docker compose logs brain | grep "Procesando market update"
# Verificar que logs muestran s√≠mbolos correctos
```

---

## üîÑ FASE 4: MARKET DATA MIGRATION

### Servicios a Migrar
- `src/services/market_data/main.py`

### Puntos de Cambio

#### 4.1: `fetch_latest_kline()`
**Antes:**
```python
async def fetch_latest_kline(symbol: str):
    symbol_normalized = normalize_symbol(symbol, format='long')
    url = f"{BINANCE_WS_BASE}{symbol_normalized.lower()}@kline_1m"
    # ...
    kline_data = {
        'symbol': normalize_symbol(symbol, format='short'),
        # ...
    }
```

**Despu√©s:**
```python
from src.domain import TradingSymbol

async def fetch_latest_kline(symbol: TradingSymbol):
    url = f"{BINANCE_WS_BASE}{symbol.to_lower()}@kline_1m"
    # ...
    kline_data = {
        'symbol': symbol.to_short(),  # ‚úÖ Consistente
        # ...
    }
```

#### 4.2: `market_data_loop()`
**Convertir `current_symbols` de `List[str]` ‚Üí `List[TradingSymbol]`**

### Tests de Verificaci√≥n
```bash
docker compose logs market-data | grep "OHLCV"
# Verificar que s√≠mbolos est√°n en formato correcto
```

---

## üîÑ FASE 5: SECONDARY SERVICES (Historical, Simulator, Optimizer)

### Servicios a Migrar
1. `src/services/historical/main.py`
2. `src/services/simulator/main.py`
3. `src/services/strategy_optimizer/main.py`

### Pattern Com√∫n
**Para TODOS estos servicios:**

```python
# Endpoints Flask
@app.route('/endpoint/<symbol_str>')
def endpoint_handler(symbol_str: str):
    symbol = TradingSymbol.from_str(symbol_str)  # ‚úÖ Validar entrada
    
    # Usar symbol.to_binance_api() para API calls
    # Usar symbol.to_short() para responses
```

---

## üîÑ FASE 6: ORDERS SERVICE

### Servicios a Migrar
- `src/services/orders/main.py`

### Puntos Cr√≠ticos

#### 6.1: `stop_loss_worker()`
**Parsear s√≠mbolos de Redis correctamente**

#### 6.2: Trade Creation
**IMPORTANTE:** SQLite a√∫n usa `String(20)` para symbol column.

**Estrategia:**
```python
# Al escribir a DB
trade = Trade(
    symbol=symbol.to_short(),  # Store as "BTC"
    # ...
)

# Al leer de DB
trade = session.query(Trade).first()
symbol = TradingSymbol.from_str(trade.symbol)  # Parse back
```

---

## üîÑ FASE 7: SQLALCHEMY CUSTOM TYPE (Optional - Futuro)

### Objetivo
**Hacer que SQLite guarde y cargue TradingSymbol autom√°ticamente**

### Implementaci√≥n
```python
# src/shared/types/trading_symbol_type.py
from sqlalchemy.types import TypeDecorator, String
from src.domain import TradingSymbol

class TradingSymbolType(TypeDecorator):
    """SQLAlchemy custom type para TradingSymbol"""
    
    impl = String
    cache_ok = True
    
    def process_bind_param(self, value, dialect):
        """DB Write: TradingSymbol ‚Üí str"""
        if value is None:
            return None
        if isinstance(value, TradingSymbol):
            return value.to_short()
        return str(value)
    
    def process_result_value(self, value, dialect):
        """DB Read: str ‚Üí TradingSymbol"""
        if value is None:
            return None
        return TradingSymbol.from_str(value)
```

### Uso en Models
```python
# src/shared/database.py
from src.shared.types import TradingSymbolType

class Trade(Base):
    __tablename__ = 'trades'
    
    id = Column(Integer, primary_key=True)
    symbol = Column(TradingSymbolType(20), nullable=False)  # ‚úÖ Auto-conversion
```

**Ventaja:** ORM maneja conversi√≥n autom√°ticamente.

**NOTA:** Esta fase es OPCIONAL para V21.3. Puede quedar para V21.4.

---

## üìä TESTING STRATEGY

### Por Cada Fase

#### 1. Unit Tests
```bash
python3 test_trading_symbol.py  # Debe pasar 9/9
```

#### 2. Integration Tests
```bash
# Rebuild containers
docker compose down
docker compose build
docker compose up -d

# Verificar logs
docker compose logs <servicio> | tail -50
```

#### 3. End-to-End Tests
```bash
# Dashboard
curl http://localhost:8050/health
curl http://localhost:8050/api/dashboard_data

# Redis audit
docker compose exec dashboard python audit_redis_keys.py
```

### Rollback Strategy
**Si algo falla en una fase:**

```bash
# Revertir commit
git reset --hard HEAD~1

# O revertir archivo espec√≠fico
git checkout HEAD~1 -- src/services/dashboard/app.py

# Rebuild
docker compose build --no-cache
docker compose up -d
```

---

## üéØ CHECKLIST DE MIGRACI√ìN

### Fase 1: Foundation ‚úÖ
- [x] TradingSymbol Value Object created
- [x] Unit tests (9/9 PASSED)
- [ ] Migrate `src/shared/utils.py` (backward compat)

### Fase 2: Dashboard
- [ ] Migrate `get_realtime_price()`
- [ ] Migrate `get_market_regimes()`
- [ ] Migrate `dashboard_data()`
- [ ] Migrate `asset_detail()`
- [ ] Test: Dashboard responds 200

### Fase 3: Brain
- [ ] Migrate `warm_up_history()`
- [ ] Migrate `process_market_update()`
- [ ] Test: Warm-up works

### Fase 4: Market Data
- [ ] Migrate `fetch_latest_kline()`
- [ ] Migrate `market_data_loop()`
- [ ] Test: OHLCV published correctly

### Fase 5: Secondary Services
- [ ] Migrate Historical endpoints
- [ ] Migrate Simulator
- [ ] Migrate Strategy Optimizer
- [ ] Test: Each service individually

### Fase 6: Orders
- [ ] Migrate stop_loss_worker()
- [ ] Test: Trades execute correctly

### Fase 7: SQLAlchemy Custom Type (Optional)
- [ ] Create TradingSymbolType
- [ ] Update database.py models
- [ ] Migration script (if needed)

---

## üìà SUCCESS METRICS

**V21.3 ser√° considerado exitoso si:**

1. **100% Type Safety:** No m√°s strings sueltos para s√≠mbolos
2. **Zero Regressions:** Todos los tests de V21.2.1 siguen pasando
3. **Improved Testability:** Mocks m√°s f√°ciles (TradingSymbol en vez de str)
4. **Better Logs:** `logger.info(f"Processing {symbol}")` (usa `__str__()`)
5. **Futureproof:** F√°cil a√±adir nuevos quote currencies (BUSD, EUR)

---

## üöÄ TIMELINE ESTIMADO

| Fase | Esfuerzo | D√≠as |
|------|----------|------|
| Fase 1: utils.py | 1h | 0.5 |
| Fase 2: Dashboard | 2h | 0.5 |
| Fase 3: Brain | 2h | 0.5 |
| Fase 4: Market Data | 2h | 0.5 |
| Fase 5: Secondary | 3h | 1 |
| Fase 6: Orders | 2h | 0.5 |
| Testing Integral | 2h | 0.5 |
| **TOTAL** | **14h** | **~2 d√≠as** |

Fase 7 (SQLAlchemy Custom Type) ‚Üí **+1 d√≠a** (opcional, puede ser V21.4)

---

## üéâ RESULTADO ESPERADO

### Antes (V21.2.1)
```python
symbol = "BTC"  # ‚ö†Ô∏è string suelto, puede ser inv√°lido
key = f"price:{symbol}"  # ‚ö†Ô∏è formateo manual
```

### Despu√©s (V21.3)
```python
symbol = TradingSymbol.from_str("BTC")  # ‚úÖ Validado
key = symbol.to_redis_key("price")  # ‚úÖ Type-safe, imposible equivocarse
```

**Sistema con 99% de integridad arquitect√≥nica.**

---

**¬øProceder con la migraci√≥n? Comenzar√© por Fase 1 (utils.py backward compat).**
